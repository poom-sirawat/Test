{"files":[{"id":"551206e1-a423-41b7-afd9-f42e2203b48b","name":"appsscript","type":"json","source":"{\n  \"timeZone\": \"Asia/Bangkok\",\n  \"dependencies\": {\n  },\n  \"exceptionLogging\": \"STACKDRIVER\",\n  \"runtimeVersion\": \"V8\"\n}"},{"id":"8da39445-b240-4e83-a146-25ffedc14b4d","name":"รหัส","type":"server_js","source":"function sendInvoiceToLINE(rowIndex) {\n    var spreadsheetId \u003d \"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\"; // แทนที่ด้วยไอดีของสเปรดชีตที่ต้องการ\n    var sheet \u003d SpreadsheetApp.openById(spreadsheetId).getSheetByName(\"ข้อมูลใบแจ้งหนี้\");\n    \n    if (!sheet) {\n        return \"ไม่พบชีตที่ชื่อ \u0027ข้อมูลใบแจ้งหนี้\u0027\";\n    }\n    \n    var row \u003d sheet.getRange(rowIndex, 1, 1, sheet.getLastColumn()).getValues()[0];\n\n    // Extract values from each column used\n    var userId \u003d row[4]; // Column E (USER_ID)\n    var status \u003d row[19]; // Column T (Status)\n\n    if (status \u003d\u003d\u003d \"จัดส่งแล้ว\") {\n        // Create Flex Message\n        var flexMessage \u003d createFlexMessageFromRow(row);\n        sendFlexMessage(flexMessage, userId);\n\n        // Update status to \"จัดส่งแล้ว\" + current timestamp\n        var timestamp \u003d new Date(); // Get current timestamp\n        var newStatus \u003d \"จัดส่งแล้ว \" + timestamp.toLocaleString(\"th-TH\"); // Format timestamp to Thai locale\n        sheet.getRange(rowIndex, 20).setValue(newStatus); // Update status in Column T (20th column)\n\n        return \"Flex Message sent to userId: \" + userId + \" and status updated.\";\n    } else {\n        return \"Status is not \u0027จัดส่งแล้ว\u0027\";\n    }\n}\n\n\n\n// Function to send Flex Message to LINE\nfunction sendFlexMessage(flexMessage, userId) {\n    var lineToken \u003d \"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\"; // Enter LINE Token here\n\n    var url \u003d \"https://api.line.me/v2/bot/message/push\";\n    var options \u003d {\n        method: \"post\",\n        contentType: \"application/json\",\n        headers: {\n            \"Authorization\": \"Bearer \" + lineToken\n        },\n        payload: JSON.stringify({\n            to: userId,\n            messages: [flexMessage]\n        }),\n    };\n\n    UrlFetchApp.fetch(url, options);\n}\n\n\n// Function to create Flex Message from row data\nfunction createFlexMessageFromRow(row) {\n    // Extract values from the row array\n    var room \u003d row[3]; // Room\n    var name \u003d row[5]; // Name\n    var tel \u003d row[6]; // Phone number\n    var date \u003d row[2]; // Month\n    var rent \u003d row[7]; // Rent\n    var Belectric \u003d row[8]; // Starting electricity units\n    var Felectric \u003d row[9]; // Ending electricity units\n    var Electric \u003d row[10]; // Electricity cost\n    var Bwater \u003d row[11]; // Starting water units\n    var Fwater \u003d row[12]; // Ending water units\n    var water \u003d row[13]; // Water cost\n    var commonfee \u003d row[14]; // Common fee\n    var internet \u003d row[15]; // Internet cost\n    var other \u003d row[16]; // Other costs\n    var total \u003d row[17]; // Total amount\n\n    function toString(value) {\n        return value !\u003d\u003d null \u0026\u0026 value !\u003d\u003d undefined ? String(value) : \"0\";\n    }\n\n    // Create the Flex message\n    var flexMessage \u003d {\n        type: \"flex\",\n        altText: \"ใบแจ้งหนี้\",\n        contents: {\n            type: \"bubble\",\n            size: \"giga\",\n            body: {\n                type: \"box\",\n                layout: \"vertical\",\n                contents: [\n                    {\n                        type: \"box\",\n                        layout: \"horizontal\",\n                        contents: [\n                            {\n                                type: \"text\",\n                                text: \"หอพัก CODE DEE\", // เปลี่ยนชื่อหอพัก\n                                size: \"xl\",\n                                weight: \"bold\",\n                            },\n                            {\n                                type: \"text\",\n                                text: \"ใบแจ้งหนี้\",\n                                align: \"end\",\n                                weight: \"bold\",\n                                size: \"md\",\n                                gravity: \"center\",\n                            },\n                        ],\n                    },\n                    {\n                        type: \"text\",\n                        text: \"123 ซอยลาดพร้าว 1 เขตลาดพร้าว\", // เปลี่ยนที่อยู่บรรทัดที่ 1\n                        size: \"xs\",\n                    },\n                    {\n                        type: \"text\",\n                        text: \"แขวงลาดพร้าว กรุงเทพมหานคร 10230\", //เปลี่ยนที่อยู่บรรทัดที่ 2\n                        size: \"xs\",\n                    },\n                    {\n                        type: \"separator\",\n                        margin: \"sm\",\n                    },\n                    {\n                        type: \"box\",\n                        layout: \"horizontal\",\n                        contents: [\n                            {\n                                type: \"text\",\n                                text: \"ลูกค้า\",\n                                size: \"sm\",\n                                weight: \"bold\",\n                            },\n                            {\n                                type: \"text\",\n                                text: toString(room),\n                                align: \"end\",\n                                size: \"sm\",\n                                weight: \"bold\",\n                            },\n                        ],\n                        margin: \"md\",\n                    },\n                    {\n                        type: \"box\",\n                        layout: \"horizontal\",\n                        contents: [\n                            {\n                                type: \"text\",\n                                text: \"ชื่อ:\",\n                                flex: 0,\n                                size: \"sm\",\n                                weight: \"bold\",\n                            },\n                            {\n                                type: \"text\",\n                                text: toString(name),\n                                size: \"sm\",\n                                offsetStart: \"xs\",\n                            },\n                        ],\n                    },\n                    {\n                        type: \"box\",\n                        layout: \"horizontal\",\n                        contents: [\n                            {\n                                type: \"text\",\n                                text: \"เบอร์: \",\n                                flex: 0,\n                                size: \"sm\",\n                                weight: \"bold\",\n                            },\n                            {\n                                type: \"text\",\n                                text: toString(tel),\n                                size: \"sm\",\n                                offsetStart: \"xs\",\n                                offsetTop: \"sm\",\n                            },\n                        ],\n                    },\n                    {\n                        type: \"box\",\n                        layout: \"horizontal\",\n                        contents: [\n                            {\n                                type: \"text\",\n                                text: \"ประจำเดือนที่ : \",\n                                flex: 0,\n                                size: \"sm\",\n                                weight: \"bold\",\n                            },\n                            {\n                                type: \"text\",\n                                size: \"sm\",\n                                offsetStart: \"xs\",\n                                offsetTop: \"sm\",\n                                text: toString(date),\n                            },\n                        ],\n                    },\n                    {\n                        type: \"separator\",\n                        margin: \"xxl\",\n                    },\n                    {\n                        type: \"box\",\n                        layout: \"vertical\",\n                        margin: \"xs\",\n                        spacing: \"sm\",\n                        contents: [\n                            {\n                                type: \"box\",\n                                layout: \"horizontal\",\n                                contents: [\n                                    {\n                                        type: \"text\",\n                                        text: \"รายการ\",\n                                        size: \"md\",\n                                        color: \"#555555\",\n                                        flex: 0,\n                                        weight: \"bold\",\n                                    },\n                                    {\n                                        type: \"text\",\n                                        text: \"ค่าบริการ\",\n                                        size: \"md\",\n                                        color: \"#111111\",\n                                        align: \"end\",\n                                        weight: \"bold\",\n                                    },\n                                ],\n                            },\n                            {\n                                type: \"box\",\n                                layout: \"horizontal\",\n                                contents: [\n                                    {\n                                        type: \"text\",\n                                        text: \"ค่าเช่า\",\n                                        size: \"sm\",\n                                        color: \"#555555\",\n                                        flex: 0,\n                                    },\n                                    {\n                                        type: \"text\",\n                                        text: toString(rent),\n                                        size: \"sm\",\n                                        color: \"#111111\",\n                                        align: \"end\",\n                                    },\n                                ],\n                            },\n                            {\n                                type: \"box\",\n                                layout: \"horizontal\",\n                                contents: [\n                                    {\n                                        type: \"text\",\n                                        text: \"ค่าไฟ [\" + toString(Belectric) + \"-\" + toString(Felectric) + \"]\",\n                                        size: \"sm\",\n                                        color: \"#555555\",\n                                        flex: 0,\n                                    },\n                                    {\n                                        type: \"text\",\n                                        text: toString(Electric),\n                                        size: \"sm\",\n                                        color: \"#111111\",\n                                        align: \"end\",\n                                    },\n                                ],\n                            },\n                            {\n                                type: \"box\",\n                                layout: \"horizontal\",\n                                contents: [\n                                    {\n                                        type: \"text\",\n                                        text: \"ค่าน้ำ [\" + toString(Bwater) + \"-\" + toString(Fwater) + \"]\",\n                                        size: \"sm\",\n                                        color: \"#555555\",\n                                        flex: 0,\n                                    },\n                                    {\n                                        type: \"text\",\n                                        text: toString(water),\n                                        size: \"sm\",\n                                        color: \"#111111\",\n                                        align: \"end\",\n                                    },\n                                ],\n                            },\n                            {\n                                type: \"box\",\n                                layout: \"horizontal\",\n                                contents: [\n                                    {\n                                        type: \"text\",\n                                        text: \"ค่าส่วนกลาง\",\n                                        size: \"sm\",\n                                        color: \"#555555\",\n                                        flex: 0,\n                                    },\n                                    {\n                                        type: \"text\",\n                                        text: toString(commonfee),\n                                        size: \"sm\",\n                                        color: \"#111111\",\n                                        align: \"end\",\n                                    },\n                                ],\n                            },\n                            {\n                                type: \"box\",\n                                layout: \"horizontal\",\n                                contents: [\n                                    {\n                                        type: \"text\",\n                                        text: \"ค่าอินเทอร์เน็ต\",\n                                        size: \"sm\",\n                                        color: \"#555555\",\n                                        flex: 0,\n                                    },\n                                    {\n                                        type: \"text\",\n                                        text: toString(internet),\n                                        size: \"sm\",\n                                        color: \"#111111\",\n                                        align: \"end\",\n                                    },\n                                ],\n                            },\n                            {\n                                type: \"box\",\n                                layout: \"horizontal\",\n                                contents: [\n                                    {\n                                        type: \"text\",\n                                        text: \"อื่นๆ\",\n                                        size: \"sm\",\n                                        color: \"#555555\",\n                                        flex: 0,\n                                    },\n                                    {\n                                        type: \"text\",\n                                        text: toString(other),\n                                        size: \"sm\",\n                                        color: \"#111111\",\n                                        align: \"end\",\n                                    },\n                                ],\n                            },\n                            {\n                                type: \"separator\",\n                                margin: \"xxl\",\n                            },\n                            {\n                                type: \"box\",\n                                layout: \"horizontal\",\n                                contents: [\n                                    {\n                                        type: \"text\",\n                                        text: \"ยอดรวม\",\n                                        size: \"sm\",\n                                        color: \"#555555\",\n                                    },\n                                    {\n                                        type: \"text\",\n                                        text: toString(total),\n                                        size: \"sm\",\n                                        color: \"#111111\",\n                                        align: \"end\",\n                                    },\n                                ],\n                            },\n                        ],\n                    },\n                ],\n            },\n            footer: {\n                type: \"box\",\n                layout: \"vertical\",\n                contents: [\n                    {\n                        type: \"box\",\n                        layout: \"horizontal\",\n                        contents: [\n                            {\n                                type: \"text\",\n                                text: \"หมายเหตุ : (1) ชำระภายในวันที่ 5 ของเดือน\",\n                                size: \"sm\",\n                            },\n                        ],\n                    },\n                    {\n                        type: \"box\",\n                        layout: \"horizontal\",\n                        contents: [\n                            {\n                                type: \"text\",\n                                text: \"(เลยกำหนด มีค่าปรับ 50 บาท/วัน)\",\n                                size: \"sm\",\n                                margin: \"69px\",\n                            },\n                        ],\n                    },\n                    {\n                        type: \"separator\",\n                    },\n                    {\n                        type: \"box\",\n                        layout: \"vertical\",\n                        contents: [\n                            {\n                                type: \"text\",\n                                text: \"เลขบัญชี : 1234567890\",// เปลี่ยนเลขบัญชี\n                                size: \"xxl\",\n                                align: \"center\",\n                                color: \"#00A94F\",\n                                weight: \"bold\",\n                            },\n                            {\n                                type: \"text\",\n                                text: \"กสิกรไทย: หอพัก CODE DEE\",// เปลี่ยนชื่อธนนาคาร ชื่อบัญชี\n                                color: \"#00A94F\",\n                                align: \"center\",\n                                margin: \"sm\",\n                            },\n                        ],\n                        margin: \"xxl\",\n                    },\n                    {\n                        type: \"button\",\n                        action: {\n                            type: \"clipboard\",\n                            label: \"คัดลอกเลขบัญชี\",\n                            clipboardText: \"1234567890\", // เปลี่ยนเลขบัญชี\n                        },\n                        style: \"primary\",\n                        color: \"#00A94F\",\n                    },\n                ],\n            },\n        },\n    };\n\n    return flexMessage;\n}\n"}]}